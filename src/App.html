{#if urlParams.edit}
<div class="editor-sidebarContainer editor_sidebarExpanded">
	<div class="sidebarPanel">
		<div class="sidebarPanel-toolbarContainer">
			<div class="dropdownMenuWidget">
{#each dropdownMenu as it}
				<div class="dropdownMenuWidget-item{it.checked ? ' checked' : ''}" on:click="checkMe(it)">
					<i class="icon-{it.name}"></i>
					<span>{it.title}</span>
				</div>
{/each}
			</div>
		</div>
			<div id="editor" class="editor">{confStr}</div>
	</div>
</div>
{/if}
<div class="editor-viewerContainer editor_sidebarExpanded">
	<Map permalink={permalink} bind:map />
</div>


<script>
	const serverBase = window.serverBase || '//maps.kosmosnimki.ru/';
	import Map from './Map.html';
	export default {
		data() {
			return {
				urlParams: {},
				dropdownMenu: [
					{ name: 'refresh', title: 'Refresh' },
					{ name: 'link', title: 'Share' }
				],
				map: null,
				permalink: null,
				confStr: ''
			}
		},
		methods: {
			checkMe(it) {
console.log('checkMe', it);
			},
			editConf(node, flag) {
console.log('editConf', node, flag);
			},
			editTrigger(node, flag) {
console.log('editTrigger', node, flag);
				let parentNode = node.parentNode,
					lastChild = parentNode.parentNode.lastChild;
				if (flag) {
					lastChild.previousElementSibling.classList.remove('hidden');
					lastChild.classList.add('hidden');
				} else {
					lastChild.previousElementSibling.classList.add('hidden');
					lastChild.classList.remove('hidden');
				}
				parentNode.firstChild.classList.remove('checked');
				parentNode.lastChild.classList.remove('checked');
				node.classList.add('checked');
			},
			checkPermalink(out) {
				let {urlParams} = this.get();
				//console.log('?config=7ZSC4  dddddddd', out, urlParams)
				if (out.app) {
					out.app.theme = urlParams.theme || out.app.theme || 'dark'; 				// тема по умолчанию
					out.app.iconSidebar = urlParams.iconSidebar || out.app.iconSidebar || true;	// iconSidebar по умолчанию
					out.app.treeView = urlParams.treeView || out.app.treeView || true;			// treeView по умолчанию
					out.app.iconLayers = urlParams.iconLayers || out.app.iconLayers || true;	// iconLayers по умолчанию
					out.app.drawing = urlParams.drawing || out.app.drawing || true;				// drawing по умолчанию
					out.app.drawing = urlParams.drawing || out.app.drawing || true;				// drawing по умолчанию
					out.app.gmxTimeline = urlParams.gmxTimeline || out.app.gmxTimeline || true;	// gmxTimeline по умолчанию
				}
				this.set({permalink: out, confStr: JSON.stringify(out, null, 2)});
				L.gmxUtil.requestLink('ext/ace.js').then(() => {
					var editor = ace.edit("editor");
					editor.setTheme("ace/theme/monokai");
					editor.session.setMode("ace/mode/json");
					// editor.session.setMode("ace/mode/javascript");
					editor.container.getElementsByClassName('ace_scrollbar-v')[0].style.width = '4px';
				});
				if (out.app.gmxTimeline && out.app.gmxTimeline !== 'false') {
					L.gmxUtil.requestLink('//maps.kosmosnimki.ru/api/plugins/timeline/2.9.1/timeline.js');
					L.gmxUtil.requestLink('//maps.kosmosnimki.ru/api/plugins/timeline/2.9.1/timeline.css');
					// L.gmxUtil.requestLink('L.Control.gmxTimeLine.js');
					L.gmxUtil.requestLink('//maps.kosmosnimki.ru/api/plugins/external/GMXPluginTimeLine/L.Control.gmxTimeLine.js');
					L.gmxUtil.requestLink('//maps.kosmosnimki.ru/api/plugins/external/GMXPluginTimeLine/L.Control.gmxTimeLine.css');
				}
			},
			getPermalink(id) {
				let out = {};
				if (id) {
					fetch(serverBase + 'TinyReference/Get.ashx?WrapStyle=None&id=' + id, {
						mode: 'cors',
						credentials: 'include'
					})
					.then(res => res.json())
					.then(json => {
						if (json.Status === 'ok') {
							out = json.Result ? JSON.parse(json.Result) : {};
						}
						this.checkPermalink(out);
					});
						// .catch(err => console.log(err));
				} else {
					setTimeout(function() {
						this.checkPermalink(out);
					}.bind(this), 0);
				}
			}
		},

		components: {
			Map
		},

		oncreate() {
			// this fires when the component has been
			// rendered to the DOM
			// console.log('in oncreate');
			
		},

		onstate({ changed, current, previous }) {
// console.log('in onstate', changed, current, previous);
			if (changed.urlParams) {
				this.getPermalink(current.urlParams.config)
			}
		},

		onupdate({ changed, current, previous }) {
			// console.log('in onupdate', changed, current, previous);
			// if (current.urlParams.edit && changed.confStr) {
				// let node = document.getElementsByClassName('view')[0];
				// node.innerHTML = current.confStr;
				// hljs.highlightBlock(node);
			// }
		}
	}
</script>

<style>
#editor {
	height: calc(100% - 40px);
	top: 40px;
}

.sidebarPanel {
    font-family: 'Roboto';
	height: 100%;
}

.editor-viewerContainer {
  position: relative;
  top: 0;
  bottom: 0;
  left: 0;
  right: 0;
  overflow: hidden;
  z-index: 5;
  float: left;
  width: 100%;
}
.editor-sidebarContainer .editor-viewerContainer {
  left: 500px;
}
.editor-sidebarContainer {
  position: relative;
  top: 0;
  bottom: 0;
  left: 0;
  width: 0px;
  overflow: hidden;
  background: #fff;
  box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
  -webkit-transition: width .5s ease;
  transition: width .5s ease;
  z-index: 20;
}

.editor_sidebarExpanded.editor-sidebarContainer {
  width: 500px;
}

.hidden {
	display: none;
}
.dropdownMenuWidget {
	display: table;
}
.dropdownMenuWidget {
	height:100%
}
.dropdownMenuWidget-item {
	display: table-cell;
	vertical-align: middle;
	font-size: 14px;
	cursor: pointer;
	padding: 0px 10px;
	white-space: nowrap;
	color: #424242;
}
.dropdownMenuWidget-item:hover, .dropdownMenuWidget-item.checked {
	background:rgba(0, 0, 0, 0.05)
}

.dropdownMenuWidget.right {
    right: 0px;
	padding: 0;
    margin: 0;
    position: absolute;
    background-color: #ebebeb;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    height: 26px;
}
/*
.editor textarea {
	width:100%;
	height:-webkit-fill-available
}
.editor .view {
    white-space: pre-wrap;
}
*/
.sidebarPanel-toolbarContainer {
	position:absolute;
	top:0;
	left:0;
	right:0;
	height:40px
}
.sidebarPanel-toolbarContainer {
	border-right:1px solid #f0f0f0;
	background-color:#ebebeb;
	box-shadow:0 0 10px rgba(0, 0, 0, 0.5)
}
.sidebarPanel-codeEditorContainer {
	position:absolute;
	top:40px;
	bottom:0;
	left:0;
	right:0
}
.sidebarPanel-codeEditorContainer {
	border-right:1px solid #f0f0f0
}
.sidebarPanel-toolbarContainer {
	z-index:40
}
.sidebarPanel-codeEditorContainer {
	z-index:30
}
.pointer.title {
    position: relative;
    bottom: 4px;
}


[class^="icon-"]:before,
[class*=" icon-"]:before {
  font-family: "fontello";
  font-style: normal;
  font-weight: normal;
  speak: none;
  display: inline-block;
  text-decoration: inherit;
  width: 1em;
  margin-right: .2em;
  text-align: center;
  /* opacity: .8; */
  /* For safety - reset parent styles, that can break glyph codes*/
  font-variant: normal;
  text-transform: none;
  /* fix buttons height, for twitter bootstrap */
  line-height: 1em;
  /* Animation center compensation - margins should be symmetric */
  /* remove if not needed */
  margin-left: .2em;
  /* you can be more comfortable with increased icons size */
  /* font-size: 120%; */
  /* Uncomment for 3D effect */
  /* text-shadow: 1px 1px 1px rgba(127, 127, 127, 0.3); */
}
/*
.icon-help2:before {
  content: '\';
}

.icon-vk:before {
  content: '\';
}

.icon-right-open:before {
  content: '\';
}

.icon-twitter:before {
  content: '\';
}

.icon-facebook:before {
  content: '\';
}

.icon-user:before {
  content: '\';
}

.icon-calendar:before {
  content: '\';
}

.icon-calendar-empty:before {
  content: '\';
}

.icon-plus-squared:before {
  content: '\';
}

.icon-plus-squared-alt:before {
  content: '\';
}

.icon-minus-squared-alt:before {
  content: '\';
}

.icon-minus-squared:before {
  content: '\';
}

.icon-angle-left:before {
  content: '\';
}

.icon-angle-right:before {
  content: '\';
}

.icon-angle-up:before {
  content: '\';
}

.icon-angle-down:before {
  content: '\';
}

.icon-angle-double-left:before {
  content: '\';
}

.icon-angle-double-right:before {
  content: '\';
}

.icon-angle-double-up:before {
  content: '\';
}

.icon-angle-double-down:before {
  content: '\';
}

.icon-lock:before {
  content: '\';
}

.icon-menu:before {
  content: '\';
}

.icon-lock-open:before {
  content: '\';
}

.icon-lock-open-alt:before {
  content: '\';
}

.icon-clock:before {
  content: '\';
}

.icon-dot:before {
  content: '\';
}

.icon-dot-2:before {
  content: '\';
}

.icon-dot-3:before {
  content: '\';
}

.icon-down-dir:before {
  content: '\';
}

.icon-up-dir:before {
  content: '\';
}

.icon-left-dir:before {
  content: '\';
}

.icon-check:before {
  content: '\';
}

.icon-right-dir:before {
  content: '\';
}

.icon-info:before {
  content: '\';
}

.icon-cog:before {
  content: '\';
}

.icon-blank:before {
  content: '\';
}

.icon-link-ext:before {
  content: '\';
}

.icon-link-ext-alt:before {
  content: '\';
}

.icon-cancel:before {
  content: '\';
}

.icon-pencil:before {
  content: '\';
}

.icon-target:before {
  content: '\';
}

.icon-calendar-alt:before {
  content: '\';
}

.icon-left-open:before {
  content: '\';
}

.icon-up-open:before {
  content: '\';
}

.icon-down-open:before {
  content: '\';
}

.icon-fire:before {
  content: '\';
}

.icon-layers:before {
  content: '\';
}

.icon-magic:before {
  content: '\';
}

.icon-refresh:before {
  content: '\';
}

.icon-save:before {
  content: '\';
}

.icon-link:before {
  content: '\';
}

.icon-switch:before {
  content: '\';
}

.icon-toggle-off:before {
  content: '\';
}

.icon-toggle-on:before {
  content: '\';
}

.icon-bookmark:before {
  content: '\';
}

.icon-mail:before {
  content: '\';
}

.icon-bell:before {
  content: '\';
}

.icon-radio:before {
  content: '\';
}

.icon-play:before {
  content: '\';
}

.icon-radio-outline:before {
  content: '\';
}

.icon-pause:before {
  content: '\';
}

.icon-stop:before {
  content: '\';
}

.icon-globe:before {
  content: '\';
}

.icon-map:before {
  content: '\';
}

.icon-location:before {
  content: '\';
}

.icon-direction:before {
  content: '\';
}

.icon-eye:before {
  content: '\';
}

.icon-eye-off:before {
  content: '\';
}

.icon-undo:before {
  content: '\';
}

.icon-export:before {
  content: '\';
}

.icon-newspaper:before {
  content: '\';
}

.icon-school:before {
  content: '\';
}

.icon-fighter-jet:before {
  content: '\';
}

.icon-cloud-sun:before {
  content: '\';
}

.icon-resize-vertical:before {
  content: '\';
}

.icon-resize-full:before {
  content: '\';
}

.icon-building:before {
  content: '\';
}

.icon-ship:before {
  content: '\';
}

.icon-search:before {
  content: '\';
}

.icon-description:before {
  content: '\';
}

.icon-fullscreen:before {
  content: '\';
}

.icon-layers2:before {
  content: '\';
}

.icon-minus:before {
  content: '\';
}

.icon-plus:before {
  content: '\';
}

.icon-print:before {
  content: '\';
}

.icon-toolbar:before {
  content: '\';
}

.icon-widjet:before {
  content: '\';
}

.icon-menu2:before {
  content: '\';
}
*/
</style>
