<div id="map"></div>

<style>
</style>

<script>
	import TreeView from './TreeView.html';

	import SidebarControl from  'scanex-leaflet-sidebar';
	import 'scanex-leaflet-sidebar/dist/scanex-leaflet-sidebar.css';

	import IconLayers from 'leaflet-iconlayers';
	import 'leaflet-iconlayers/dist/iconLayers.css';

	const serverBase = window.serverBase || '//maps.kosmosnimki.ru/';

	export default {
		data() {
			return {
				layersTree: {
					visible: {}
				},
				permalink: null,
				map: null
			}
		},
		methods: {
			createMap(it) {
				let {layersTree} = this.get();
				let app = it.app || {},
					gmxMap = app.gmxMap || {},
					state = it.state || {},
					// layersTree = state.layersTree || {},
					calendar = state.calendar || {},
					mapID = gmxMap.mapID || '946GH',
					apiKey = gmxMap.apiKey,
					pos = state.map ? state.map.position : {};

					
				layersTree = state.layersTree || layersTree;
				this.layersTree = layersTree;
				let map = new L.Map('map', {
					srs: 3857,
					layers: [],
					center: new L.LatLng(pos.y || 0, pos.x || 60),
					zoom: pos.z || 3
				});

				map.gmxControlsManager.init({
					gmxDrawing: {position: 'right'},
					gmxZoom: {position: 'gmxbottomright'},
					gmxHide: null
				});
				map.gmxControlsManager.setSvgSprites('//www.kosmosnimki.ru/lib/geomixer_1.3/img/svg-symbols.svg');

				var iconSidebar = new SidebarControl({position: 'topleft'});
				iconSidebar.addTo(map);
				var treePane = iconSidebar.addTab({id: 'treeView', icon: 'icon-layers', opened: 'opened', closed: 'closed'});
				this.iconSidebar = iconSidebar;
				this.treePane = treePane;

				this.mapID = mapID;
				let opt = {
					leafletMap: map,
					// visibleItemOnly: true,	// только видимые элементы (слои и папки)
					setZIndex: true
					// ,
					// visibility: layersTree.visible || {}
				};
				L.gmx.loadMap(mapID, opt).then(function(gmxMap) {
					this.gmxMap = gmxMap;
					gmxMap.layers.forEach((it) => {
						if(it._map) {
							layersTree.visible[it._gmx.layerID] = true;
						}
					});
					// let visible = layersTree.visible || {};
					// L.gmx.gmxMapManager.iterateNode(gmxMap.rawTree, function(node) {
						// let props = node.content.properties,
							// layerId = props.name;
						// if (layerId && layerId in visible && visible[layerId] !== props.visible) {
							// props.visible = visible[layerId];
						// }
					// });

					// this.set({layersTree: layersTree}); 
					// this.set({gmxMap: gmxMap}); 
					iconSidebar.on('change', e => {
						let id = e.detail.current;
						if (id === 'treeView') {
							this._initTree({container: treePane, layersTree: layersTree, rawTree: gmxMap.rawTree});
						} else {
							treePane.innerHTML = '';
						}
					});
this.iconSidebar.setCurrent('treeView');

					/* TimeLine */
					var control = L.control.gmxTimeline({
						moveable: true
						}).on('dateInterval', function (ev) {
							gmxMap.layersByID[ev.layerID].setDateInterval(ev.beginDate, ev.endDate);
						})
						.on('statechanged', function (ev) {
							console.log('statechanged', ev);
						})
						.on('click', function (ev) {
							gmxMap.layersByID[ev.layerID].repaint();
						});

					// map.addControl(control);
					this.gmxTimeline = control;
					this._initBaseLayers(map, gmxMap.properties.BaseLayers);
				}.bind(this));
				this.set({map: map, config: it});
			},
			_initBaseLayers(map, baseLayers) {
				const lang = 'rus';
				let blm = map.gmxBaseLayersManager;
				blm.initDefaults().then(function() {
					blm.setActiveIDs(baseLayers);
					let layers = blm.getActiveIDs().map(id => {
						var layer = blm.get(id);
						if (!layer) {
							return null;
						} else {
							return {
								layer: layer,
								icon: layer.options.icon,
								title: layer.options[lang]
							}
						}
					}).filter(e => e);

					let baseLayersControl = new IconLayers(layers, {id: 'iconLayers'});
					map.gmxControlsManager.add(baseLayersControl);
					map.addControl(baseLayersControl);
				});
			},
			_getNodeIndex(target) {
				let arr = target.parentNode.children,
					i, len;
				for(i = 0, len = arr.length; i < len; i++) {
					if (arr[i] === target) break;
				}
				return i === len ? null : i;
			},

			_initTree(it) {
				let rawTree = {
					type: 'map',
					content: it.rawTree
				};
				const app = new TreeView({
					appendNode: (id) => {
						if (this.gmxMap.nodes) {
							let {map} = this.get();
							let mapID = this.mapID,
								layersTree = this.layersTree,
								visible = layersTree.visible || {},
								// mapItem = L.gmx._maps['maps.kosmosnimki.ru'][mapID],
								gmxMap = this.gmxMap,
								layersByID = gmxMap.layersByID;
							L.gmx.gmxMapManager.getMapFolder({
								treeConfig: layersTree,
								mapId: mapID,
								folderId: id
							}).then(function(json) {
								L.gmx.gmxMapManager.iterateNode(json.content, function(node) {
									let props = node.content.properties,
										layerId = props.name;
									if (layerId && layerId in visible && visible[layerId] !== props.visible) {
										props.visible = visible[layerId];
									}
								}, {nodes: gmxMap.nodes});
								gmxMap.addLayersToMap(map);
								this.treePane.innerHTML = '';
								this._initTree({
									container: this.treePane,
									layersTree: this.layersTree,
									rawTree: gmxMap.rawTree
								});

							}.bind(this));
						}
					},
					target: it.container,
					data: {
						container: it.container,
						layersTree: it.layersTree,
						rawTree: rawTree
					}
				});
				this._treeView = app;

				app.on('command', (ev) => {
					let {map} = this.get();
					let cmd = ev.cmd,
						target = ev.originalEvent.target,
						gmxMap = this.gmxMap,
						node = gmxMap.nodes ? gmxMap.nodes[ev.id] : true,
						gmxLayer = gmxMap.layersByID[ev.id];

					// console.log('Map command', ev, gmxLayer, gmxMap);
					if (gmxLayer) {
						if (cmd === 'fitBounds') {
							map.fitBounds(gmxLayer.getBounds());
						} else if (cmd === 'toggleVisibility') {
							// if (target.checked) {
							if (gmxLayer._map) {
								map.removeLayer(gmxLayer);
							} else {
								map.addLayer(gmxLayer);
							}
						} else if (cmd === 'toggleTimeline') {
							if (target.classList.contains('enabled')) {
								if (!this.gmxTimeline._map) {
									map.addControl(this.gmxTimeline);
								}
								this.gmxTimeline.addLayer(gmxLayer);
							} else {
								this.gmxTimeline.removeLayer(gmxLayer);
							}
						} else if (cmd === 'toggleStyle') {
							let num = this._getNodeIndex(target.parentNode),
								styles = gmxLayer.getStyles();
							if (target.classList.contains('enabled')) {
								target.classList.remove('enabled');
								styles[num].disabled = true;
							} else {
								target.classList.add('enabled');
								delete styles[num].disabled;
							}
							gmxLayer.setStyles(styles);
						}
					} else {
						if (cmd === 'toggleVisibility' && !node) {
							app.appendNode(ev.id);
						}
					}
				});
			}
		},
		
		onstate({ changed, current, previous }) {
			if (changed.permalink && current.permalink) {
				this.createMap(current.permalink);
			}
		}
	}
</script>
