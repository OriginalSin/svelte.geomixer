<div id="map"></div>

<style>
</style>

<script>
	import TreeView from './TreeView.html';

	const serverBase = window.serverBase || '//maps.kosmosnimki.ru/';

	export default {
		data() {
			return {
				permalink: null,
				map: null
			}
		},
		methods: {
			createMap(it) {
				let app = it.app || {},
					gmxMap = app.gmxMap || {},
					state = it.state || {},
					layersTree = state.layersTree,
					calendar = state.calendar || {},
					mapID = gmxMap.mapID || '946GH',
					apiKey = gmxMap.apiKey,
					pos = state.map ? state.map.position : {};

				var osm = L.tileLayer('//tilessputnik.ru/{z}/{x}/{y}.png', {
					maxZoom: 18
				});
//layersTree.visible['6D24C9ED5F5C4F3189AABDC2CE8A751F'] = true;
				let map = new L.Map('map', {
					srs: 3857,
					layers: [osm],
					center: new L.LatLng(pos.y || 0, pos.x || 60),
					zoom: pos.z || 3
				});

				var iconSidebar = L.control.iconSidebar({width111: 360});
				map.addControl(iconSidebar);
				var node = L.DomUtil.create('div', 'treeViewCont'),
					tabIcon = L.DomUtil.create('div', 'tabIcon', node),
					tabCont = L.DomUtil.create('div', 'tabCont', node);
				tabIcon.innerHTML = '<svg role="img" class="svgIcon"><use xlink:href="#overlays" href="#overlays"></use></svg>';

				var treePane = iconSidebar.setPane('treeView', {
					createTab: function(state) {
						if (state === 'active') {
							L.DomUtil.addClass(node, 'icon_active')
						} else {
							L.DomUtil.removeClass(node, 'icon_active')
						}
						return node
					}
				});

				map.gmxControlsManager.init();
				map.gmxControlsManager.setSvgSprites('//www.kosmosnimki.ru/lib/geomixer_1.3/img/svg-symbols.svg');

				this.mapID = mapID;
				let opt = {
					leafletMap: map,
					visibleItemOnly: true,	// только видимые элементы (слои и папки)
					setZIndex: true,
					visibility: layersTree.visible
				};
				L.gmx.loadMap(mapID, opt).then(function(gmxMap) {
					this.set({gmxMap: gmxMap}); 

					iconSidebar.on('opened', function(e) {
						if (e.id === 'treeView') {
							this._initTree({container: treePane, layersTree: layersTree, rawTree: gmxMap.rawTree});
						}
					}, this);
					iconSidebar.open('treeView', true);

					/* TimeLine */
					var control = L.control.gmxTimeline({
						moveable: true
					})	.on('dateInterval', function (ev) {
							gmxMap.layersByID[ev.layerID].setDateInterval(ev.beginDate, ev.endDate);
						})
						.on('statechanged', function (ev) {
							console.log('statechanged', ev);
						})
						.on('click', function (ev) {
							gmxMap.layersByID[ev.layerID].repaint();
						});

					// map.addControl(control);
					this.gmxTimeline = control;
				}.bind(this));
				this.set({map: map, config: it});
			},
			_createLayer(layerID) {
				let _maps = L.gmx._maps,
					host = 'maps.kosmosnimki.ru',
					info = _maps[host] && _maps[host][this.mapID] && _maps[host][this.mapID]._nodes[layerID] ? _maps[host][this.mapID]._nodes[layerID] :
							L.gmx.gmxMapManager.findLayerInfo('maps.kosmosnimki.ru', this.mapID, layerID);
				// console.log('_createLayer', info);
				return info ? L.gmx.createLayer(info.content, {
					layerID: layerID
					// ,
					// srs: 3857
				}) : null;

			},
			_getNodeIndex(target) {
				let arr = target.parentNode.children,
					i, len;
				for(i = 0, len = arr.length; i < len; i++) {
					if (arr[i] === target) break;
				}
				return i === len ? null : i;
			},
			_initTree(it) {
				let rawTree = {
					type: 'map',
					content: it.rawTree
				};
				const app = new TreeView({
					target: it.container,
					data: {
						container: it.container,
						layersTree: it.layersTree,
						// config: it.config,
						rawTree: rawTree
					}
				});
				this._treeView = app;

				app.on('command', (ev) => {
					let {map, gmxMap} = this.get();
					let cmd = ev.cmd,
						target = ev.originalEvent.target,
						gmxLayer = gmxMap.layersByID[ev.id];
						// gmxLayer = this._createLayer(ev.id);

console.log('Map command', ev, gmxLayer, gmxMap);
					if (gmxLayer) {
						if (cmd === 'fitBounds') {
							map.fitBounds(gmxLayer.getBounds());
						} else if (cmd === 'toggleVisibility') {
							// if (target.checked) {
							if (gmxLayer._map) {
								map.removeLayer(gmxLayer);
							} else {
								map.addLayer(gmxLayer);
							}
						} else if (cmd === 'toggleTimeline') {
							if (target.classList.contains('enabled')) {
								if (!this.gmxTimeline._map) {
									map.addControl(this.gmxTimeline);
								}
								this.gmxTimeline.addLayer(gmxLayer);
							} else {
								this.gmxTimeline.removeLayer(gmxLayer);
							}
						} else if (cmd === 'toggleStyle') {
							let num = this._getNodeIndex(target.parentNode),
								styles = gmxLayer.getStyles();
							if (target.classList.contains('enabled')) {
								target.classList.remove('enabled');
								styles[num].disabled = true;
							} else {
								target.classList.add('enabled');
								delete styles[num].disabled;
							}
							gmxLayer.setStyles(styles);
						}
					} else {
						if (cmd === 'toggleVisibility') {
							L.gmx.gmxMapManager.getMapFolder({mapId: this.mapID, folderId: ev.id}).then(function(attr) {
								app.set({rawTree: rawTree});

console.log('________', attr);
							});
						}
					}
				});
			}
		},
		
		onstate({ changed, current, previous }) {
			if (changed.permalink && current.permalink) {
				this.createMap(current.permalink);
			}
		}
	}
</script>
