<div id="map"></div>

<style>
</style>

<script>
	import TreeView from './TreeView.html';
	// import EventedTreeView from './TreeView.js';

	const serverBase = window.serverBase || '//maps.kosmosnimki.ru/';

	export default {
		data() {
			return {
				permalink: null,
				map: null
			}
		},
		methods: {
			createMap(it) {
				// console.log('createMap', it);
				let app = it.app || {},
					gmxMap = app.gmxMap || {},
					state = it.state || {},
					mapID = gmxMap.mapID || '946GH',
					apiKey = gmxMap.apiKey,
					pos = state.map ? state.map.position : {};

				var osm = L.tileLayer('//tilessputnik.ru/{z}/{x}/{y}.png', {
					maxZoom: 18
				});

				let map = new L.Map('map', {
					layers: [osm],
					center: new L.LatLng(pos.y || 0, pos.x || 60),
					zoom: pos.z || 3
				});

				var iconSidebar = L.control.iconSidebar({width111: 360});
				map.addControl(iconSidebar);
				var node = L.DomUtil.create('div', 'treeViewCont'),
					tabIcon = L.DomUtil.create('div', 'tabIcon', node),
					tabCont = L.DomUtil.create('div', 'tabCont', node);
				tabIcon.innerHTML = '<svg role="img" class="svgIcon"><use xlink:href="#overlays" href="#overlays"></use></svg>';

				var treePane = iconSidebar.setPane('treeView', {
					createTab: function(state) {
						if (state === 'active') {
							L.DomUtil.addClass(node, 'icon_active')
						} else {
							L.DomUtil.removeClass(node, 'icon_active')
						}
						return node
					}
				});

				map.gmxControlsManager.init();
				
				L.gmx.loadMap(mapID, {leafletMap: map}).then(function(gmxMap) {
					iconSidebar.on('opened', function(e) {
						if (e.id === 'treeView') {
							this._initTree({container: treePane, rawTree: gmxMap.rawTree});
						}
					}, this);
					iconSidebar.open('treeView', true);
				}.bind(this));
				this.set({map: map});
			},
			_initTree(it) {
				// const app = new EventedTreeView({
				const app = new TreeView({
					target: it.container,
					data: {
						container: it.container,
						// rawTree: it.rawTree
						rawTree: {
							type: 'map',
							content: it.rawTree
						}
					}
				});
// this.on('foo', e => console.log('hhhhhhhhhhhhhhh', e));
app.on('foo', ({ changed, current, previous }) => {
	console.log('sdddddddddddtate changed', current);
});
				// app.on('foo', e => console.log('hhhhhhhhhhhhhhh', e));
console.log('_initTree', it); // true
			}
		},
		// components: {
			// TreeView: './TreeView.html'
		// },

		onstate({ changed, current, previous }) {
// console.log('Map in onstate', changed, current, previous);
			if (changed.permalink && current.permalink) {
				this.createMap(current.permalink);
				//this.getPermalink(current.urlParams.config)
			}
		}
	}
</script>
